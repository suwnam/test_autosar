pipeline {
    agent any

    environment {
        REMOTE_USER = 'swnam'
        REMOTE_HOST = '192.168.0.23'
        REMOTE_PATH = '/home/swnam/Jenkins/backup_jenkins.sh'

        SCRIPT_NAME = 'backup_jenkins.sh'
    }

    stages {
        stage('Check script exists') {
            steps {
                sh 'ls -l $SCRIPT_NAME'
            }
        }

        stage('Transfer & Run Backup Script') {
            steps {
                sshagent (credentials: ['vm-ssh-key']) {
                    withCredentials([
                        string(credentialsId: 'RESTIC_PASSWORD', variable: 'RESTIC_PASSWORD')
                    ]) {
                        sh '''
                            echo "[+] Copying script to remote server"
                            scp -o StrictHostKeyChecking=no $SCRIPT_NAME $REMOTE_USER@$REMOTE_HOST:$REMOTE_PATH

                            echo "[+] Running backup script on remote server"
                            ssh -o StrictHostKeyChecking=no $REMOTE_USER@$REMOTE_HOST "
                                export RESTIC_REPO_JENKINS='$RESTIC_REPO/test_jenkins' &&
                                export RESTIC_PASSWORD='$RESTIC_PASSWORD' &&
                                bash $REMOTE_PATH
                            "
                        '''
                }
            }
        }
    }
}

